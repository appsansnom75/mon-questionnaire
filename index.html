<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Questionnaire Adaptatif</title>
<style>
body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
h2 { color: #333; }
button { margin: 5px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
input { padding: 5px; font-size: 16px; margin-right: 10px; }
</style>
</head>
<body>
<h2 id="title">Questionnaire</h2>
<div id="question">Chargement…</div>

<script type="module">
const WORKER_URL = "https://compatibility-worker.appsansnom.workers.dev/"

let questions = [], asked=[], answers=[], scores={}, current=null

// --- Fonction eligible ---
function eligible(q){
  if(asked.includes(q.id)) return false
  if(!q.trigger_rule || q.trigger_rule==="always") return true
  try{
    const parts = q.trigger_rule.split(":")
    const type = parts[0]
    switch(type){
      case "always": return true
      case "score_high":
        const dim = parts[1], threshold=parseFloat(parts[2]||"0")
        return (scores[dim]||0)>=threshold
      case "contradiction":
        const cDim = parts[1]
        return (scores[cDim]||0)<0.5
      case "priority_dimension":
        const pDim = parts[1]
        return (scores[pDim]||0)>0
      case "extreme_answer":
        return answers.some(a=>a.value===2)
      default: return true
    }
  }catch(e){
    console.warn("Erreur trigger_rule", q.id, e)
    return true
  }
}

// --- Affiche question ---
function renderQuestion(){
  const container = document.getElementById("question")
  container.innerHTML=""
  const p = document.createElement("p")
  p.innerText=current.text
  container.appendChild(p)
  const mapping = current.response_score_mapping||[]
  if(current.type==="scale"){
    ["Pas du tout","Un peu","Beaucoup"].forEach((label,i)=>{
      const btn=document.createElement("button")
      btn.innerText=label
      btn.onclick=()=>recordAnswer(mapping[i]??i)
      container.appendChild(btn)
    })
  } else if(current.type==="yesno" || current.type==="choices"){
    current.options.forEach((label,i)=>{
      const btn=document.createElement("button")
      btn.innerText=label
      btn.onclick=()=>recordAnswer(mapping[i]??i)
      container.appendChild(btn)
    })
  } else if(current.type==="text"){
    const input=document.createElement("input")
    input.type="text"
    input.id="textAnswer"
    const btn=document.createElement("button")
    btn.innerText="Valider"
    btn.onclick=()=>recordAnswer(0)
    container.appendChild(input)
    container.appendChild(btn)
  }
}

// --- Enregistre réponse ---
function recordAnswer(val){
  answers.push({dimension:current.dimension,value:val})
  scores[current.dimension]=(scores[current.dimension]||0)+val
  nextQuestion()
}

// --- Prochaine question ---
function nextQuestion(){
  const remaining = questions.filter(q=>!asked.includes(q.id))
  const q = remaining.find(eligible)
  if(!q) return finish()
  asked.push(q.id)
  current=q
  renderQuestion()
}

// --- Fin questionnaire ---
async function finish(){
  document.getElementById("title").innerText="Calcul en cours…"
  document.getElementById("question").innerText=""

  try{
    const MY_PROFILE={securite:0.7,autonomie:0.4}

    const r1 = await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"profile",answers})
    })
    const profile = await r1.json()

    const r2 = await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"compatibility",me:MY_PROFILE,friend:profile})
    })
    const res = await r2.json()

    document.body.innerHTML=`
      <h2>Compatibilité : ${res.percent ?? 0}%</h2>
      <p>${res.explanation ?? "Aucune explication disponible."}</p>
    `
  }catch(e){
    console.error(e)
    document.body.innerHTML="<h2>Erreur lors du calcul de compatibilité.</h2>"
  }
}

// --- Charger questions via Worker ---
async function loadQuestions(){
  try{
    const res = await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"get_questions"})
    })
    questions = await res.json()
    nextQuestion()
  }catch(e){
    console.error("Impossible de charger les questions",e)
    document.getElementById("question").innerText="Impossible de charger les questions."
  }
}

// --- Lancement ---
loadQuestions()
</script>
</body>
</html>
