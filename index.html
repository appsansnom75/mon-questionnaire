<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Questionnaire Adaptatif</title>
<style>
body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
h2 { color: #333; }
button { margin: 5px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
input { padding: 5px; font-size: 16px; margin-right: 10px; }
</style>
</head>
<body>
<h2 id="title">Questionnaire</h2>
<div id="question">Chargement…</div>

<script type="module">

const WORKER_URL = "https://compatibility-worker.appsansnom.workers.dev/"

let questions = [
  { id:1, text:"Aimes-tu le chocolat ?", type:"yesno", options:["Oui","Non"], dimension:"gout", trigger_rule:"always" },
  { id:2, text:"Es-tu plutôt matin ou soir ?", type:"choices", options:["Matin","Soir"], dimension:"rythme", trigger_rule:"always" },
  { id:3, text:"Te considères-tu autonome ?", type:"scale", dimension:"autonomie", response_score_mapping:[0,1,2], trigger_rule:"always" }
]

let asked=[], answers=[], scores={}, current=null

function eligible(q){
  if(asked.includes(q.id)) return false
  if(!q.trigger_rule || q.trigger_rule==="always") return true
  try{
    const expr = q.trigger_rule.replace(/\b(\w+)\b/g,(_,d)=>`(scores["${d}"]||0)`)
    return eval(expr)
  }catch{return false}
}

function renderQuestion(){
  const container = document.getElementById("question")
  container.innerHTML=""
  const p = document.createElement("p")
  p.innerText = current.text
  container.appendChild(p)
  const mapping = current.response_score_mapping||[]

  if(current.type==="scale"){
    ["Pas du tout","Un peu","Beaucoup"].forEach((label,i)=>{
      const btn = document.createElement("button")
      btn.innerText=label
      btn.onclick=()=>recordAnswer(mapping[i]??i)
      container.appendChild(btn)
    })
  } else {
    current.options.forEach((label,i)=>{
      const btn = document.createElement("button")
      btn.innerText=label
      btn.onclick=()=>recordAnswer(mapping[i]??i)
      container.appendChild(btn)
    })
  }
}

function recordAnswer(val){
  answers.push({dimension:current.dimension,value:val})
  scores[current.dimension]=(scores[current.dimension]||0)+val
  nextQuestion()
}

function nextQuestion(){
  if(asked.length>=questions.length) return finish()
  const q=questions.find(eligible)
  if(!q) return finish()
  asked.push(q.id)
  current=q
  renderQuestion()
}

async function finish(){
  document.getElementById("title").innerText="Calcul en cours…"
  document.getElementById("question").innerText=""

  try{
    const MY_PROFILE={securite:0.7,autonomie:0.4}

    const r1 = await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"profile",answers})
    })
    const profile = await r1.json()

    const r2 = await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"compatibility",me:MY_PROFILE,friend:profile})
    })
    const res = await r2.json()

    document.body.innerHTML=`
      <h2>Compatibilité : ${res.percent ?? 0}%</h2>
      <p>${res.explanation ?? "Aucune explication disponible."}</p>
    `

  }catch(e){
    console.error(e)
    document.body.innerHTML="<h2>Erreur lors du calcul de compatibilité.</h2>"
  }
}

nextQuestion()

</script>
</body>
</html>
